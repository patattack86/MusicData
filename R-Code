

devtools::install_github("josiahparry/geniusR")   # the geniusR package isn't on CRAN, so load with devtools
library(geniusR) 
library(tidyverse)
library(tidytext)
library(rvest)
library(readr)
library(lubridate)
library(igraph)
library(ggraph)
library(readr)

wiki_url <- "https://en.wikipedia.org/wiki/Taylor_Swift_discography"

# pulling album titles
alb_titles <- html_session(wiki_url) %>% 
  html_nodes(".plainrowheaders:nth-child(11) tr~ tr+ tr th") %>%   # found the html node using SelectorGadget
  html_text() %>% 
  data_frame()

names(alb_titles) <- c("title")

# getting release dates
alb_dates <- html_session(wiki_url) %>% 
  html_nodes(".plainrowheaders:nth-child(11) th+ td li:nth-child(1)") %>%
  # again, found the right node by using SelectorGadget
  html_text() %>% 
  data_frame()
 
names(alb_dates) <- c("date")

# combining the two data frames
albums <- cbind(alb_titles, alb_dates)

head(albums)

albums$date <- gsub("Released: ", "", albums$date)

albums$date <- trimws(albums$date)

albums$date <- as.Date(albums$date, "%B %d, %Y")

write_csv(albums, "taylor_swift_albums.csv")

taylor_lyr <- data_frame()
for(i in 1:nrow(albums)){
  current_lyr <- genius_album("Taylor Swift", albums$title[i]) %>% 
    mutate(album = albums$title[i])
  taylor_lyr <- rbind(taylor_lyr, current_lyr)
  message(albums$title[i])
}

taylor_lyr <- taylor_lyr %>% 
  inner_join(albums, by = c("album" = "title"))

write_csv(taylor_lyr, "taylor_lyr.csv")

word <- c("beer", "wine", "alcohol", "drink", "drunk", "champagne", "bar", "whiskey", "liquor")

alcohol_words <- data_frame(word)

# importing albums dataset

albums <- read_csv("~/taylor_swift_albums.csv")

## Parsed with column specification:
## cols(
##   title = col_character(),
##   date = col_date(format = "")
## )

taylor_lyr <- read_csv("~/RProjects/taylor_lyr.csv")

## Parsed with column specification:
## cols(
##   title = col_character(),
##   track_n = col_integer(),
##   text = col_character(),
##   album = col_character(),
##   date = col_date(format = "")
## )

taylor_words <- taylor_lyr %>% 
  unnest_tokens(word, text)

taylor_words %>% 
  inner_join(alcohol_words) %>% 
  group_by(album, date, word) %>% 
  summarise(n = n()) %>% 
  right_join(albums) %>% 
  replace_na(list(word = NA, n = 0)) %>% 
  ggplot(aes(x = reorder(title, date), y = n, fill = word)) +
  scale_y_continuous(minor_breaks = 1:16) +
  geom_col(colour = "lightgrey") +
  labs(y = "Number of Times Used",
       x = "Album",
       title = "Alcohol References in Taylor Swift Lyrics, by Album") +
  theme(panel.background = element_rect(fill = "white"),
        panel.grid.major = element_line(colour = "lightgrey"),
        panel.grid.minor = element_line(colour = "lightgrey"))
        
        
